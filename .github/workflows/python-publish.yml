name: Python CI with FastAPI & Docker Deploy

on:
  pull_request: 
    types:
      - closed
    branches:
      - main
  #테스트 돌리는용
  push:
    branches: [ "main" ]
      
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1. Checkout code
      - uses: actions/checkout@v4

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 3. Cache pip packages
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. Install dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 5. make .env file
      - name: make .env file
        run: |
          touch .env
          chmod 644 .env
          echo "${{ secrets.ENV_FILE }}" | base64 --decode > .env

      # 6. Generate Dockerfile
      - name: Generate Dockerfile
        run: |
          tee Dockerfile << EOF
          FROM python:3.11-slim
          
          WORKDIR /app
          
          # 시스템 의존성 설치 (opencv-python, psycopg2 등에 필요)
          RUN apt-get update && apt-get install -y \
              gcc \
              g++ \
              libpq-dev \
              libgl1-mesa-glx \
              libglib2.0-0 \
              && rm -rf /var/lib/apt/lists/*
          
          # Python 의존성 설치
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          
          # 애플리케이션 코드 복사
          COPY . .
          
          # .env 파일 복사
          COPY .env .env
          
          EXPOSE 8080
          
          # uvicorn으로 FastAPI 실행
          CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8080"]
          EOF

      # 7. Build Docker image
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/ai-app --platform linux/amd64 .

      # 8. Docker Hub login
      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # 9. Push image to Docker Hub
      - name: Push to Docker Hub
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/ai-app
        
      # 10. Deploy to EC2
      - name: Deploy to EC2
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/ai-app:latest
          CONTAINER_NAME=ai_app
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > deploy_key.pem
          chmod 600 deploy_key.pem
      
          ssh -i deploy_key.pem -o StrictHostKeyChecking=no \
              ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << EOF
            REMOTE_IMAGE=${IMAGE}
            REMOTE_CONTAINER_NAME=${CONTAINER_NAME}
      
            # 1) 기존 컨테이너 강제 종료·삭제
            if sudo docker ps -a | grep -q \${REMOTE_CONTAINER_NAME}; then
              echo "Found existing container: \${REMOTE_CONTAINER_NAME}"
              sudo docker rm -f \${REMOTE_CONTAINER_NAME}
            else
              echo "No existing container found: \${REMOTE_CONTAINER_NAME}"
            fi
      
            # 2) 이미지 풀 & 새 컨테이너 실행
            sudo docker pull \${REMOTE_IMAGE}
            sudo docker run -d \
              --name \${REMOTE_CONTAINER_NAME} \
              -p 8081:8080 \
              -v /etc/localtime:/etc/localtime:ro \
              -v /etc/timezone:/etc/timezone:ro \
              --env-file .env \
              --restart unless-stopped \
              \${REMOTE_IMAGE}
      
            # 3) 사용하지 않는 이미지·볼륨 정리
            sudo docker system prune -a -f --volumes
          EOF

